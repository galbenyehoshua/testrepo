# Ensure you have the ActiveDirectory module installed and imported
Import-Module ActiveDirectory

# Input CSV file path
$inputFile = "C:\path\to\your\inputfile.csv"

# Output CSV file path
$outputFile = "C:\path\to\your\outputfile.csv"

# Import data from input CSV
$inputData = Import-Csv -Path $inputFile

# Prepare an array to store output data
$outputData = @()

# Loop through each row in the input data
foreach ($user in $inputData) {
    # Create a username by combining first name and last name (lowercased or any other format as needed)
    $userName = ($user.FirstName.Substring(0,1) + $user.LastName).ToLower()

    # Query Active Directory to find the user by their first and last name
    $adUser = Get-ADUser -Filter {GivenName -eq $user.FirstName -and Surname -eq $user.LastName} -Properties telephoneNumber

    # Check if the user is found in AD
    if ($adUser) {
        # Retrieve the extension (assuming it's stored in the telephoneNumber or another attribute)
        $extension = $adUser.telephoneNumber  # You can adjust this line if the extension is stored in another attribute like 'extensionAttribute1'
    } else {
        # If user not found, set extension to a default value or leave blank
        $extension = "Not Found"
    }

    # Add the new user data to the output array
    $outputData += [PSCustomObject]@{
        UserName  = $userName
        FirstName = $user.FirstName
        LastName  = $user.LastName
        Extension = $extension
    }
}

# Export the output data to a new CSV file
$outputData | Export-Csv -Path $outputFile -NoTypeInformation

Write-Host "Processing complete. Output saved to $outputFile"
