param(
    [Parameter(Mandatory=$true)]
    [string]$folderPath,
    [Parameter(Mandatory=$true)]
    [string]$outputExcelFile
)

# Check if ImportExcel module is available
if (-not (Get-Module -ListAvailable -Name ImportExcel)) {
    Write-Host "ImportExcel module is not installed. Please install it first." -ForegroundColor Red
    exit
}

# Create a new Excel package
try {
    $excelPackage = New-ExcelPackage -Path $outputExcelFile
} catch {
    Write-Host "Failed to create Excel package. Error: $_" -ForegroundColor Red
    exit
}

# Get all CSV files in the specified folder
$csvFiles = Get-ChildItem -Path $folderPath -Filter "*.csv"

if ($csvFiles.Count -eq 0) {
    Write-Host "No CSV files found in the specified folder." -ForegroundColor Yellow
    exit
}

foreach ($csvFile in $csvFiles) {
    if (Test-Path $csvFile.FullName) {
        # Get the file name without the extension for the tab name
        $tabName = [System.IO.Path]::GetFileNameWithoutExtension($csvFile.Name)

        # Import CSV data
        $data = Import-Csv -Path $csvFile.FullName

        # Add data to a new worksheet
        $data | Export-Excel -ExcelPackage $excelPackage -WorksheetName $tabName -AutoSize -TableName $tabName
    } else {
        Write-Host "File not found: $csvFile.FullName" -ForegroundColor Yellow
    }
}

# Save the Excel package
try {
    Close-ExcelPackage $excelPackage
    Write-Host "Excel file created at $outputExcelFile"
} catch {
    Write-Host "Failed to save the Excel package. Error: $_" -ForegroundColor Red
}
